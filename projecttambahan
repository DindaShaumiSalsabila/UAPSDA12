import csv
import tkinter as tk
from tkinter import messagebox, filedialog

class PesertaKarate:
    def _init_(self, id: str, nama: str):
        self.id = id
        self.nama = nama
        self.skor = 0 

    def tambah_skor(self, nilai: int):
        self.skor += nilai  

    def skor_tertinggi(self) -> int:
        return self.skor  

    def rata_skor(self) -> float:
        return self.skor  

class SistemScoringKarate:
    def _init_(self):
        self.peserta = {}

    def daftar_peserta(self, id: str, nama: str):
        id = id.strip().lower()  # Normalize ID
        if id not in self.peserta:
            self.peserta[id] = PesertaKarate(id, nama)
            return f"✓ Peserta {nama} (ID: {id}) terdaftar"
        else:
            return f"× ID {id} sudah ada"

    def tambah_skor(self, id: str, skor: int):
        id = id.strip().lower()  
        if id in self.peserta:
            self.peserta[id].tambah_skor(skor)
            return f"✓ Skor {skor} ditambahkan untuk {self.peserta[id].nama}, total: {self.peserta[id].skor}"
        else:
            return f"× ID {id} tidak ditemukan"

    def import_csv(self, filepath):
        results = []
        try:
            with open(filepath, mode='r', newline='', encoding='utf-8') as file:
                reader = csv.reader(file)
                header = next(reader, None)  
                for row in reader:
                    if len(row) >= 2:
                        id, nama = row[0].strip().lower(), row[1].strip()  
                        result = self.daftar_peserta(id, nama)
                        results.append(result)
                        if len(row) > 4 and row[4]:
                            scores = row[4].split(',')
                            for score in scores:
                                try:
                                    score = int(score.strip())
                                    result = self.tambah_skor(id, score)
                                    results.append(result)
                                except ValueError:
                                    results.append(f"× Skor tidak valid untuk {nama}: {score}")
                    else:
                        results.append("× Baris tidak lengkap")
            return results
        except Exception as e:
            return [f"× Gagal mengimpor CSV: {str(e)}"]

    def urutkan_skor_tertinggi(self):
        peserta_dengan_skor = [(peserta.skor, peserta) for peserta in self.peserta.values()]
        return sorted(peserta_dengan_skor, key=lambda x: x[0], reverse=True)

    def urutkan_id(self):
        return sorted(self.peserta.values(), key=lambda x: x.id)

    def ekspor_csv(self, filepath):
        with open(filepath, mode='w', newline='', encoding='utf-8') as file:
            writer = csv.writer(file)
            writer.writerow(["ID", "Nama", "Skor Total"])
            for peserta in self.peserta.values():
                writer.writerow([
                    peserta.id,
                    peserta.nama,
                    peserta.skor
                ])
